pr:
  branches:
    include:
      - '*'
    exclude:
      - main

variables:
  pnpm_config_cache: $(Pipeline.Workspace)/.pnpm-store

steps:
- checkout: self
  persistCredentials: true

- task: NodeTool@0
  displayName: 'Install Node.js'
  inputs:
    versionSpec: '20.x'

- task: CmdLine@2
  displayName: "â³ Running git pull"
  inputs:
    script: |
      git pull --force origin main:main
      ls -la

- task: CmdLine@2
  displayName: "ğŸ¦‹ Checking status"
  continueOnError: false
  inputs:
    script: |
      FILES=$(find ./.changeset -name "*.md")
      if [ -z "$FILES" ]; then
        echo "No changesets found"
        exit 1
      else
        echo "There are changesets!"
      fi

- task: Cache@2
  inputs:
    key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
    path: $(pnpm_config_cache)
  displayName: Cache pnpm

- script: |
    corepack enable
    corepack prepare pnpm@latest-8 --activate
  displayName: "ğŸ“¦ Setting up PNPM"

- script: pnpm config set store-dir $(pnpm_config_cache)
  displayName: "ğŸ’¾ Create cache"

- task: CmdLine@2
  displayName: "â³ Installing dependencies"
  inputs:
    script: |
      pnpm install

- task: CmdLine@2
  displayName: "ğŸ‘®ğŸ¿ Checking TS/JS linting"
  continueOnError: true
  inputs:
    script: |
      pnpm run ci:lint

- task: CmdLine@2
  displayName: "ğŸ‘©â€ğŸ¨ Checking SCSS linting"
  continueOnError: false
  inputs:
    script: |
      pnpm run ci:lint:styles


- task: CmdLine@2
  displayName: "ğŸ—ï¸ Building monorepo"
  continueOnError: false
  inputs:
    script: |
      pnpm run build